<!DOCTYPE html>
<html lang="en">
<head>
    <title>Add window</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div>
        <form>
            <div>
                <label for="addTag">
                    <input id="tagName" type="text" name="tag">
                </label>
                <button id="addTagButton" type="button">Add Tag</button>
                <div id="tagContainer" class="tag-container"></div>
                <p>Enter image</p>
                <input type="file" id="image"/>
            </div>
            <button class="btn" type="submit">Add image</button>
        </form>
    </div>

    <script>
        const electron = require('electron');
        const {ipcRenderer} = electron;

        const addTagButton = document.getElementById('addTagButton');
        addTagButton.addEventListener('click',handleAddTag);

        const form = document.querySelector('form');
        form.addEventListener('submit', submitForm);

        function submitForm(event){
            event.preventDefault();
            ipcRenderer.send('item:add', getFileObject());
        }

        function getFileObject(){
            let file = document.getElementById('image').files[0];
            return {
                name: getFileName(file.name),
                size: getFileSize(file.size),
                type: getFileExtension(file.name),
                path: getPathWithoutFileName(file.path),
                tags: getTagsValue()
            }
        }

        function getFileName(fileName){
            return fileName.substring(0, fileName.lastIndexOf('.'));
        }

        function getPathWithoutFileName(path){
            return path.substring(0, path.lastIndexOf('\\')+1);
        }

        function getFileExtension(fileName){
            return fileName.substring(fileName.lastIndexOf('.')+1, fileName.length);
        }

        function getFileSize(size){
            let units = ['KB','MB','GB'];

            if(Math.abs(size) < 1024) {
                return size + ' B';
            }

            let u = -1;
            do{
                size /= 1024;
                ++u;
            } while(Math.abs(size) >= 1024 && u < units.length -1);

            return size.toFixed(1) + ' ' + units[u];
        }

        function handleAddTag(){
            const tagContainer = document.getElementById('tagContainer');
            const tagName = document.getElementById('tagName').value;
            if(validateTag(tagName,tagContainer)){
                const tagLabel = `<label name="tag" class="tag">${tagName}</label>`;
                tagContainer.insertAdjacentHTML("beforeend", tagLabel);
            }
        }

        function validateTag(tagName,tagContainer){
            let tags = getTagsValue();
            if(tags.length === 0){
                return true;
            }

            return !tags.some(tag => tag === tagName);
        }

        function getTagsValue(){
            const tagLabels = tagContainer.querySelectorAll('label');
            let tags = [];
            
            for(let i=0;i<tagLabels.length;i++){
                tags.push(tagLabels[i].textContent);
            }

            return tags;
        }
    </script>
</body>
</html>